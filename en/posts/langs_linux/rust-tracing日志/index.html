<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Rust Tracing日志 | Reid's Blog</title>
<meta name=keywords content="Rust,log,tracing"><meta name=description content="Rust Tracing日志"><meta name=author content="Reid"><link rel=canonical href=https://reid00.github.io/en/posts/langs_linux/rust-tracing%E6%97%A5%E5%BF%97/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://reid00.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://reid00.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://reid00.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://reid00.github.io/apple-touch-icon.png><link rel=mask-icon href=https://reid00.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://reid00.github.io/en/posts/langs_linux/rust-tracing%E6%97%A5%E5%BF%97/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><head><meta name=referrer content="no-referrer"></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-QRR6GRNQGK"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-QRR6GRNQGK")}</script><meta property="og:title" content="Rust Tracing日志"><meta property="og:description" content="Rust Tracing日志"><meta property="og:type" content="article"><meta property="og:url" content="https://reid00.github.io/en/posts/langs_linux/rust-tracing%E6%97%A5%E5%BF%97/"><meta property="og:image" content="https://i.loli.net/2021/09/26/3OMGXylm8HUYJ6p.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-07-17T17:19:11+08:00"><meta property="article:modified_time" content="2024-07-17T17:19:11+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://i.loli.net/2021/09/26/3OMGXylm8HUYJ6p.png"><meta name=twitter:title content="Rust Tracing日志"><meta name=twitter:description content="Rust Tracing日志"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://reid00.github.io/en/posts/"},{"@type":"ListItem","position":2,"name":"学习的编程语言Golang，Python，Rust 和Linux 相关的记录 ","item":"https://reid00.github.io/en/posts/langs_linux/"},{"@type":"ListItem","position":3,"name":"Rust Tracing日志","item":"https://reid00.github.io/en/posts/langs_linux/rust-tracing%E6%97%A5%E5%BF%97/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Rust Tracing日志","name":"Rust Tracing日志","description":"Rust Tracing日志","keywords":["Rust","log","tracing"],"articleBody":"介绍 严格来说，tracing 并不是一个日志库，而是一个分布式跟踪的 SDK，用于采集监控数据的。\n随着微服务的流行，现在一个产品有多个系统组成是非常常见的，这种情况下，一条用户请求可能会横跨几个甚至几十个服务。此时再用传统的日志方式去跟踪这条用户请求就变得较为困难，这就是分布式追踪在现代化监控系统中这么炽手可热的原因。\n关于分布式追踪，在后面的监控章节进行详细介绍，大家只要知道：分布式追踪的核心就是在请求的开始生成一个 trace_id，然后将该 trace_id 一直往后透穿，请求经过的每个服务都会使用该 trace_id 记录相关信息，最终将整个请求形成一个完整的链路予以记录下来。\n那么后面当要查询这次请求的相关信息时，只要使用 trace_id 就可以获取整个请求链路的所有信息了，非常简单好用。看到这里，相信大家也明白为什么这个库的名称叫 tracing 了吧？\n至于为何把它归到日志库的范畴呢？因为 tracing 支持 log 门面库的 API，因此，它既可以作为分布式追踪的 SDK 来使用，也可以作为日志库来使用。\n在分布式追踪中，trace_id 都是由 SDK 自动生成和往后透穿，对于用户的使用来说是完全透明的。如果你要手动用日志的方式来实现请求链路的追踪，那么就必须考虑 trace_id 的手动生成、透传，以及不同语言之间的协议规范等问题\n异步编程中的挑战 除了分布式追踪，在异步编程中使用传统的日志也是存在一些问题的，最大的挑战就在于异步任务的执行没有确定的顺序，那么输出的日志也将没有确定的顺序并混在一起，无法按照我们想要的逻辑顺序串联起来。\n归根到底，在于日志只能针对某个时间点进行记录，缺乏上下文信息，而线程间的执行顺序又是不确定的，因此日志就有些无能为力。而 tracing 为了解决这个问题，引入了 span 的概念( 这个概念也来自于分布式追踪 )，一个 span 代表了一个时间段，拥有开始和结束时间，在此期间的所有类型数据、结构化数据、文本数据都可以记录其中。\n大家发现了吗？ span 是可以拥有上下文信息的，这样就能帮我们把信息按照所需的逻辑性串联起来了。\ntracing 库 tracing 中最重要的三个概念是 Span、Event 和 Collector。\ntracing 各个模块 ​tracing​​: 作用域内的结构化日志记录和诊断系统。 ​tracing_appender​: 记录事件和跨度的编写者。也就是将日志写入文件或者控制台。 ​tracing_error​: 增强错误处理跟踪诊断信息的实用工具。 ​tracing_flame​: 用于生成折叠堆栈跟踪以生成Inferno火焰图和火焰图表的跟踪订阅者。 ​tracing_log​: 用于连接标准库日志系统和tracing系统的连接器。 ​tracing_subscriber​: 用于实现和组成tracing订阅者的工具集合。\nSpan 跨度 相比起日志只能记录在某个时间点发生的事件，span 最大的意义就在于它可以记录一个过程，也就是在某一段时间内发生的事件流。既然是记录时间段，那自然有开始和结束: Cargo.toml\n1 2 3 4 5 6 7 8 9 10 [package] name = \"demo\" version = \"0.1.0\" edition = \"2021\" # See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html [dependencies] tracing = \"0.1.37\" tracing-subscriber = { version = \"0.3.16\", features = [\"env-filter\", \"json\"] } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 use tracing::{info, span, Level}; use tracing_subscriber::{fmt, layer::SubscriberExt, util::SubscriberInitExt}; fn main() { tracing_subscriber::registry().with(fmt::layer()).init(); let span = span!(Level::TRACE, \"my_span\"); { // `enter` 返回一个 RAII ，当其被 drop 时，将自动结束该 span let enter = span.enter(); // 这里开始进入 `my_span` 的上下文 // 下面执行一些任务，并记录一些信息到 `my_span` 中 // ... info!(\"belog to my_span\"); } // 这里 enter 将被 drop，`my_span` 也随之结束 info!(\"out of my_span\") } output:\n1 2 2024-07-17T09:33:44.277725Z INFO my_span: demo: belog to my_span 2024-07-17T09:33:44.278300Z INFO demo: out of my_span Event 事件 Event 代表了某个时间点发生的事件，这方面它跟日志类似，但是不同的是，Event 还可以产生在 span 的上下文中。\n在 tracing 中，当 info!、error! 等日志宏被调用时，就会产生一个相应的事件 Event。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 use tracing::{event, span, Level}; use tracing_subscriber::{fmt, layer::SubscriberExt, util::SubscriberInitExt}; fn main() { tracing_subscriber::registry().with(fmt::layer()).init(); // 在 span 的上下文之外记录一次 event 事件 event!(Level::INFO, \"something happened\"); let span = span!(Level::INFO, \"my_span\"); let _guard = span.enter(); // 在 \"my_span\" 的上下文中记录一次 event event!(Level::DEBUG, \"something happened inside my_span\"); // span 嵌套 let s2 = span!(Level::WARN, \"span_2\"); let _g2 = s2.enter(); // 在两个span 中记录一次event event!(Level::INFO, \"something went wrong in my_span and span_2\"); drop(_g2); // 先drop里面的span 才行 // 强行结束span 的lifetime event!(Level::WARN, \"something happened out of my_span\") } output\n1 2 3 4 2024-07-17T09:42:39.162843Z INFO demo: something happened 2024-07-17T09:42:39.163364Z DEBUG my_span: demo: something happened inside my_span 2024-07-17T09:42:39.163768Z INFO my_span:span_2: demo: something went wrong in my_span and span_2 2024-07-17T09:42:39.163974Z WARN my_span: demo: something happened out of my_span 虽然 event 在哪里都可以使用，但是最好只在 span 的上下文中使用：用于代表一个时间点发生的事件，例如记录 HTTP 请求返回的状态码，从队列中获取一个对象，等等。\nCollector 收集器 当 Span 或 Event 发生时，它们会被实现了 Collect 特征的收集器所记录或聚合。这个过程是通过通知的方式实现的：当 Event 发生或者 Span 开始/结束时，会调用 Collect 特征的相应方法通知 Collector。\ntracing-subscriber 我们前面提到只有使用了 tracing-subscriber 后，日志才能输出到控制台中。\n之前大家可能还不理解，现在应该明白了，它是一个 Collector，可以将记录的日志收集后，再输出到控制台中。\n使用方法 span! 宏 跨度！ 宏 span! 宏可以用于创建一个 Span 结构体，然后通过调用结构体的 enter 方法来开始，再通过超出作用域时的 drop 来结束。\nspan! 宏可以用于创建一个 Span 结构体，然后通过调用结构体的 enter 方法来开始，再通过超出作用域时的 drop 来结束。 上面span已经给出例子\n#[instrument] 如果想要将某个函数的整个函数体都设置为 span 的范围，最简单的方法就是为函数标记上 #[instrument]，此时 tracing 会自动为函数创建一个 span，span 名跟函数名相同，在输出的信息中还会自动带上函数参数。\n1 2 3 4 5 6 7 8 9 10 11 12 use tracing::{info, instrument}; use tracing_subscriber::{fmt, layer::SubscriberExt, util::SubscriberInitExt}; #[instrument] fn foo(ans: i32) { info!(\"in foo\"); } fn main() { tracing_subscriber::registry().with(fmt::layer()).init(); foo(42); } output\n1 2024-07-17T09:48:23.493047Z INFO foo{ans=42}: demo: in foo in_scope 对于没有内置 tracing 支持或者无法使用 #instrument 的函数，例如外部库的函数，我们可以使用 Span 结构体的 in_scope 方法，它可以将同步代码包裹在一个 span 中：\n1 2 3 use tracing::info_span; let json = info_span!(\"json.parse\").in_scope(|| serde_json::from_slice(\u0026buf))?; 在 async 中使用 span 需要注意，如果是在异步编程时使用，要避免以下使用方式:\n1 2 3 4 5 6 7 8 9 10 11 async fn my_async_function() { let span = info_span!(\"my_async_function\"); // WARNING: 该 span 直到 drop 后才结束，因此在 .await 期间，span 依然处于工作中状态 let _enter = span.enter(); // 在这里 span 依然在记录，但是 .await 会让出当前任务的执行权，然后运行时会去运行其它任务，此时这个 span 可能会记录其它任务的执行信息，最终记录了不正确的 trace 信息 some_other_async_function().await // ... } 建议使用下面的方式，简单有效:\n1 2 3 4 5 6 7 8 9 10 use tracing::{info, instrument}; use tokio::{io::AsyncWriteExt, net::TcpStream}; use std::io; #[instrument] async fn write(stream: \u0026mut TcpStream) -\u003e io::Result\u003cusize\u003e { let result = stream.write(b\"hello world\\n\").await; info!(\"wrote to stream; success={:?}\", result.is_ok()); result } 那有同学可能要问了，是不是我们无法在异步代码中使用 span.enter 了，答案是：是也不是。\n是，你无法直接使用 span.enter 语法了，原因上面也说过，但是可以通过下面的方式来曲线使用：\n1 2 3 4 5 6 7 8 9 use tracing::Instrument; let my_future = async { // ... }; my_future .instrument(tracing::info_span!(\"my_future\")) .await 日志初始化写到文件和console 中 在同一个线程中写入到文件 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 use tracing::{debug, error, event, info, Level}; use tracing_appender::rolling; use tracing_subscriber::{ filter, fmt, fmt::{format::Writer, time::FormatTime}, layer::SubscriberExt, registry, util::SubscriberInitExt, Layer, }; // 用来格式化日志的输出时间格式 struct LocalTimer; // // 注意，使用chrono::Local::now()的效率相对会差一些，因为每次获取时间都要探测本机的时区。因此可改进为使用Offset的方式，明确指定时区，无需探测： // impl FormatTime for LocalTimer { // fn format_time(\u0026self, w: \u0026mut Writer\u003c'_\u003e) -\u003e std::fmt::Result { // write!(w, \"{}\", chrono::Local::now().format(\"%FT%T%.3f\")) // } // } const fn east8() -\u003e Option\u003cchrono::FixedOffset\u003e { chrono::FixedOffset::east_opt(8 * 3600) } impl FormatTime for LocalTimer { fn format_time(\u0026self, w: \u0026mut Writer\u003c'_\u003e) -\u003e std::fmt::Result { let now = chrono::Utc::now().with_timezone(\u0026east8().unwrap()); write!(w, \"{}\", now.format(\"%FT%T%.3f\")) } } pub fn logger_init() { // 文件输出层 let file_appender = rolling::daily(\"logs/\", \"log\"); // let (non_blocking_appender, _guard) = non_blocking(file_appender); // 输出非阻塞 registry() // first layer for console output, use pretty formatter and level filter .with( fmt::layer() .with_timer(LocalTimer) .pretty() .with_filter(filter::LevelFilter::from(Level::WARN)), ) // second layer for log file appender, use json formatter, no filter .with( fmt::layer() .with_timer(LocalTimer) .with_ansi(false) .json() .with_writer(file_appender) .with_filter(filter::LevelFilter::from_level(Level::INFO)), ) .init(); // _guard } fn main() { // tracing_subscriber::fmt::init(); let _ = logger_init(); event!(Level::INFO, passwd = \"passwd\"); let foo = 42; info!(foo, \"Hello from tracing\"); debug!(foo, \"hello at debug level\"); error!(foo, \"error will be in file\"); } cargo.toml\n1 2 3 4 5 [dependencies] tracing = \"0.1.37\" tracing-subscriber = { version = \"0.3.16\", features = [\"json\"] } tracing-appender = \"0.2\" chrono = \"0.4\" 当然，还有其它一些方式设置tracing-subscriber日志时间的时区和格式。例如可以通过它的fmt::time::OffsetTime指定时区，不过它使用的是time crate，因此如果记录非UTC时区，则先设置Cargo.toml：\n1 2 tracing-subscriber = {version = \"0.3\", features = [\"time\"]} time = { version = \"0.3\", features = [\"macros\"] } 1 2 3 4 5 6 7 8 9 10 11 use time::macros::{format_description, offset}; use tracing_subscriber::fmt::time::OffsetTime; fn main() { let time_fmt = format_description!(\"[year]-[month]-[day]T[hour]:[minute]:[second].[subsecond digits:3]\"); let timer = OffsetTime::new(offset!(+8), time_fmt); tracing_subscriber::fmt().with_timer(timer).init(); let offset = 2; tracing::info!(\"offset: {}, hello world\", offset); } 使用非阻塞输出 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 use tracing::{debug, error, event, info, Level}; use tracing_appender::non_blocking; use tracing_appender::rolling; use tracing_subscriber::{ filter, fmt, fmt::{format::Writer, time::FormatTime}, layer::SubscriberExt, registry, util::SubscriberInitExt, Layer, }; // 用来格式化日志的输出时间格式 struct LocalTimer; // // 注意，使用chrono::Local::now()的效率相对会差一些，因为每次获取时间都要探测本机的时区。因此可改进为使用Offset的方式，明确指定时区，无需探测： // impl FormatTime for LocalTimer { // fn format_time(\u0026self, w: \u0026mut Writer\u003c'_\u003e) -\u003e std::fmt::Result { // write!(w, \"{}\", chrono::Local::now().format(\"%FT%T%.3f\")) // } // } const fn east8() -\u003e Option\u003cchrono::FixedOffset\u003e { chrono::FixedOffset::east_opt(8 * 3600) } impl FormatTime for LocalTimer { fn format_time(\u0026self, w: \u0026mut Writer\u003c'_\u003e) -\u003e std::fmt::Result { let now = chrono::Utc::now().with_timezone(\u0026east8().unwrap()); write!(w, \"{}\", now.format(\"%FT%T%.3f\")) } } pub fn logger_init() -\u003e non_blocking::WorkerGuard { // 文件输出层 let file_appender = rolling::daily(\"logs/\", \"log\"); let (non_blocking_appender, _guard) = non_blocking(file_appender); // 输出非阻塞 registry() // first layer for console output, use pretty formatter and level filter .with( fmt::layer() .with_timer(LocalTimer) .pretty() .with_filter(filter::LevelFilter::from(Level::WARN)), ) // second layer for log file appender, use json formatter, no filter .with( fmt::layer() .with_timer(LocalTimer) .with_ansi(false) .json() .with_writer(non_blocking_appender) .with_filter(filter::LevelFilter::from_level(Level::INFO)), ) .init(); _guard } fn main() { // 需注意，使用tracing_appender时，因为是先缓冲日志信息，而不是直接写入文件。他要求必须在main()函数中使用Guard，否则guard被丢弃将不会写入任何信息到文件 let _g = logger_init(); event!(Level::INFO, passwd = \"passwd\"); let foo = 42; info!(foo, \"Hello from tracing\"); debug!(foo, \"hello at debug level\"); error!(foo, \"error will be in file\"); } ","wordCount":"3567","inLanguage":"en","image":"https://i.loli.net/2021/09/26/3OMGXylm8HUYJ6p.png","datePublished":"2024-07-17T17:19:11+08:00","dateModified":"2024-07-17T17:19:11+08:00","author":[{"@type":"Person","name":"Reid"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://reid00.github.io/en/posts/langs_linux/rust-tracing%E6%97%A5%E5%BF%97/"},"publisher":{"@type":"Organization","name":"Reid's Blog","logo":{"@type":"ImageObject","url":"https://reid00.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://reid00.github.io/en/ accesskey=h title="Reid's Blog (Alt + H)">Reid's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://reid00.github.io/en/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://reid00.github.io/en/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://reid00.github.io/en/categories/ title=Categorys><span>Categorys</span></a></li><li><a href=https://reid00.github.io/en/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://reid00.github.io/en/>Home</a>&nbsp;»&nbsp;<a href=https://reid00.github.io/en/posts/>Posts</a>&nbsp;»&nbsp;<a href=https://reid00.github.io/en/posts/langs_linux/>学习的编程语言Golang，Python，Rust 和Linux 相关的记录</a></div><h1 class="post-title entry-hint-parent">Rust Tracing日志</h1><div class=post-description>Rust Tracing日志</div><div class=post-meta><span title='2024-07-17 17:19:11 +0800 +0800'>2024-07-17 17:19</span>&nbsp;·&nbsp;8 min&nbsp;·&nbsp;3567 words&nbsp;·&nbsp;Reid</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e4%bb%8b%e7%bb%8d aria-label=介绍>介绍</a><ul><li><a href=#%e5%bc%82%e6%ad%a5%e7%bc%96%e7%a8%8b%e4%b8%ad%e7%9a%84%e6%8c%91%e6%88%98 aria-label=异步编程中的挑战>异步编程中的挑战</a></li></ul></li><li><a href=#tracing-%e5%ba%93 aria-label="tracing 库">tracing 库</a><ul><li><a href=#tracing-%e5%90%84%e4%b8%aa%e6%a8%a1%e5%9d%97 aria-label="tracing 各个模块">tracing 各个模块</a></li><li><a href=#span-%e8%b7%a8%e5%ba%a6 aria-label="Span 跨度">Span 跨度</a></li><li><a href=#event-%e4%ba%8b%e4%bb%b6 aria-label="Event 事件">Event 事件</a></li><li><a href=#collector-%e6%94%b6%e9%9b%86%e5%99%a8 aria-label="Collector 收集器">Collector 收集器</a><ul><li><a href=#tracing-subscriber aria-label=tracing-subscriber>tracing-subscriber</a></li></ul></li></ul></li><li><a href=#%e4%bd%bf%e7%94%a8%e6%96%b9%e6%b3%95 aria-label=使用方法>使用方法</a><ul><li><a href=#span-%e5%ae%8f-%e8%b7%a8%e5%ba%a6-%e5%ae%8f aria-label="span! 宏 跨度！ 宏">span! 宏 跨度！ 宏</a></li><li><a href=#instrument aria-label=#[instrument]>#[instrument]</a></li><li><a href=#in_scope aria-label=in_scope>in_scope</a></li><li><a href=#%e5%9c%a8-async-%e4%b8%ad%e4%bd%bf%e7%94%a8-span aria-label="在 async 中使用 span">在 async 中使用 span</a></li></ul></li><li><a href=#%e6%97%a5%e5%bf%97%e5%88%9d%e5%a7%8b%e5%8c%96%e5%86%99%e5%88%b0%e6%96%87%e4%bb%b6%e5%92%8cconsole-%e4%b8%ad aria-label="日志初始化写到文件和console 中">日志初始化写到文件和console 中</a></li></ul></div></details></div><div class=post-content><h1 id=介绍>介绍<a hidden class=anchor aria-hidden=true href=#介绍>#</a></h1><p>严格来说，tracing 并不是一个日志库，而是一个分布式跟踪的 SDK，用于采集监控数据的。</p><p>随着微服务的流行，现在一个产品有多个系统组成是非常常见的，这种情况下，一条用户请求可能会横跨几个甚至几十个服务。此时再用传统的日志方式去跟踪这条用户请求就变得较为困难，这就是分布式追踪在现代化监控系统中这么炽手可热的原因。</p><p>关于分布式追踪，在后面的监控章节进行详细介绍，大家只要知道：分布式追踪的核心就是在请求的开始生成一个 trace_id，然后将该 trace_id 一直往后透穿，请求经过的每个服务都会使用该 trace_id 记录相关信息，最终将整个请求形成一个完整的链路予以记录下来。</p><p>那么后面当要查询这次请求的相关信息时，只要使用 trace_id 就可以获取整个请求链路的所有信息了，非常简单好用。看到这里，相信大家也明白为什么这个库的名称叫 tracing 了吧？</p><p>至于为何把它归到日志库的范畴呢？因为 tracing 支持 log 门面库的 API，因此，它既可以作为分布式追踪的 SDK 来使用，也可以作为日志库来使用。</p><p>在分布式追踪中，trace_id 都是由 SDK 自动生成和往后透穿，对于用户的使用来说是完全透明的。如果你要手动用日志的方式来实现请求链路的追踪，那么就必须考虑 trace_id 的手动生成、透传，以及不同语言之间的协议规范等问题</p><h2 id=异步编程中的挑战>异步编程中的挑战<a hidden class=anchor aria-hidden=true href=#异步编程中的挑战>#</a></h2><p>除了分布式追踪，在异步编程中使用传统的日志也是存在一些问题的，最大的挑战就在于异步任务的执行没有确定的顺序，那么输出的日志也将没有确定的顺序并混在一起，无法按照我们想要的逻辑顺序串联起来。</p><p><strong>归根到底，在于日志只能针对某个时间点进行记录，缺乏上下文信息，而线程间的执行顺序又是不确定的，因此日志就有些无能为力</strong>。而 tracing 为了解决这个问题，引入了 span 的概念( 这个概念也来自于分布式追踪 )，一个 span 代表了一个时间段，拥有开始和结束时间，在此期间的所有类型数据、结构化数据、文本数据都可以记录其中。</p><p>大家发现了吗？ span 是可以拥有上下文信息的，这样就能帮我们把信息按照所需的逻辑性串联起来了。</p><h1 id=tracing-库>tracing 库<a hidden class=anchor aria-hidden=true href=#tracing-库>#</a></h1><p>tracing 中最重要的三个概念是 Span、Event 和 Collector。</p><h2 id=tracing-各个模块>tracing 各个模块<a hidden class=anchor aria-hidden=true href=#tracing-各个模块>#</a></h2><p><code>​tracing​​:</code> 作用域内的结构化日志记录和诊断系统。
<code>​tracing_appender​:</code> 记录事件和跨度的编写者。也就是将日志写入文件或者控制台。
<code>​tracing_error​:</code> 增强错误处理跟踪诊断信息的实用工具。
<code>​tracing_flame​:</code> 用于生成折叠堆栈跟踪以生成Inferno火焰图和火焰图表的跟踪订阅者。
<code>​tracing_log​: </code>用于连接标准库日志系统和tracing系统的连接器。
<code>​tracing_subscriber​:</code> 用于实现和组成tracing订阅者的工具集合。</p><h2 id=span-跨度>Span 跨度<a hidden class=anchor aria-hidden=true href=#span-跨度>#</a></h2><p>相比起日志只能记录在某个时间点发生的事件，span 最大的意义就在于它可以记录一个过程，也就是在某一段时间内发生的事件流。既然是记录时间段，那自然有开始和结束:
Cargo.toml</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[</span><span class=nx>package</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>name</span> <span class=p>=</span> <span class=s2>&#34;demo&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>version</span> <span class=p>=</span> <span class=s2>&#34;0.1.0&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>edition</span> <span class=p>=</span> <span class=s2>&#34;2021&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>dependencies</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>tracing</span> <span class=p>=</span> <span class=s2>&#34;0.1.37&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>tracing-subscriber</span> <span class=p>=</span> <span class=p>{</span> <span class=nx>version</span> <span class=p>=</span> <span class=s2>&#34;0.3.16&#34;</span><span class=p>,</span> <span class=nx>features</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;env-filter&#34;</span><span class=p>,</span> <span class=s2>&#34;json&#34;</span><span class=p>]</span> <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>tracing</span>::<span class=p>{</span><span class=n>info</span><span class=p>,</span><span class=w> </span><span class=n>span</span><span class=p>,</span><span class=w> </span><span class=n>Level</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>tracing_subscriber</span>::<span class=p>{</span><span class=n>fmt</span><span class=p>,</span><span class=w> </span><span class=n>layer</span>::<span class=n>SubscriberExt</span><span class=p>,</span><span class=w> </span><span class=n>util</span>::<span class=n>SubscriberInitExt</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>tracing_subscriber</span>::<span class=n>registry</span><span class=p>().</span><span class=n>with</span><span class=p>(</span><span class=n>fmt</span>::<span class=n>layer</span><span class=p>()).</span><span class=n>init</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>span</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=fm>span!</span><span class=p>(</span><span class=n>Level</span>::<span class=no>TRACE</span><span class=p>,</span><span class=w> </span><span class=s>&#34;my_span&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// `enter` 返回一个 RAII ，当其被 drop 时，将自动结束该 span
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>enter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>span</span><span class=p>.</span><span class=n>enter</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 这里开始进入 `my_span` 的上下文
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=c1>// 下面执行一些任务，并记录一些信息到 `my_span` 中
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=fm>info!</span><span class=p>(</span><span class=s>&#34;belog to my_span&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=c1>// 这里 enter 将被 drop，`my_span` 也随之结束
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>info!</span><span class=p>(</span><span class=s>&#34;out of my_span&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>output:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=mi>2024</span><span class=o>-</span><span class=mi>07</span><span class=o>-</span><span class=mi>17</span><span class=n>T09</span>:<span class=mi>33</span>:<span class=mf>44.277725</span><span class=n>Z</span><span class=w>  </span><span class=no>INFO</span><span class=w> </span><span class=n>my_span</span>: <span class=nc>demo</span>: <span class=nc>belog</span><span class=w> </span><span class=n>to</span><span class=w> </span><span class=n>my_span</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>2024</span><span class=o>-</span><span class=mi>07</span><span class=o>-</span><span class=mi>17</span><span class=n>T09</span>:<span class=mi>33</span>:<span class=mf>44.278300</span><span class=n>Z</span><span class=w>  </span><span class=no>INFO</span><span class=w> </span><span class=n>demo</span>: <span class=nc>out</span><span class=w> </span><span class=n>of</span><span class=w> </span><span class=n>my_span</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=event-事件>Event 事件<a hidden class=anchor aria-hidden=true href=#event-事件>#</a></h2><p><code>Event</code> 代表了某个时间点发生的事件，这方面它跟日志类似，但是不同的是，Event 还可以产生在 span 的上下文中。</p><p>在 tracing 中，当 info!、error! 等日志宏被调用时，就会产生一个相应的事件 Event。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>tracing</span>::<span class=p>{</span><span class=n>event</span><span class=p>,</span><span class=w> </span><span class=n>span</span><span class=p>,</span><span class=w> </span><span class=n>Level</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>tracing_subscriber</span>::<span class=p>{</span><span class=n>fmt</span><span class=p>,</span><span class=w> </span><span class=n>layer</span>::<span class=n>SubscriberExt</span><span class=p>,</span><span class=w> </span><span class=n>util</span>::<span class=n>SubscriberInitExt</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>tracing_subscriber</span>::<span class=n>registry</span><span class=p>().</span><span class=n>with</span><span class=p>(</span><span class=n>fmt</span>::<span class=n>layer</span><span class=p>()).</span><span class=n>init</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 在 span 的上下文之外记录一次 event 事件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=fm>event!</span><span class=p>(</span><span class=n>Level</span>::<span class=no>INFO</span><span class=p>,</span><span class=w> </span><span class=s>&#34;something happened&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>span</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=fm>span!</span><span class=p>(</span><span class=n>Level</span>::<span class=no>INFO</span><span class=p>,</span><span class=w> </span><span class=s>&#34;my_span&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>_guard</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>span</span><span class=p>.</span><span class=n>enter</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 在 &#34;my_span&#34; 的上下文中记录一次 event
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=fm>event!</span><span class=p>(</span><span class=n>Level</span>::<span class=no>DEBUG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;something happened inside my_span&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// span 嵌套
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>s2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=fm>span!</span><span class=p>(</span><span class=n>Level</span>::<span class=no>WARN</span><span class=p>,</span><span class=w> </span><span class=s>&#34;span_2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>_g2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>s2</span><span class=p>.</span><span class=n>enter</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 在两个span 中记录一次event
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=fm>event!</span><span class=p>(</span><span class=n>Level</span>::<span class=no>INFO</span><span class=p>,</span><span class=w> </span><span class=s>&#34;something went wrong in my_span and span_2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>drop</span><span class=p>(</span><span class=n>_g2</span><span class=p>);</span><span class=w>    </span><span class=c1>// 先drop里面的span 才行
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1>// 强行结束span 的lifetime
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=fm>event!</span><span class=p>(</span><span class=n>Level</span>::<span class=no>WARN</span><span class=p>,</span><span class=w> </span><span class=s>&#34;something happened out of my_span&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>output</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=mi>2024</span><span class=o>-</span><span class=mi>07</span><span class=o>-</span><span class=mi>17</span><span class=n>T09</span>:<span class=mi>42</span>:<span class=mf>39.162843</span><span class=n>Z</span><span class=w>  </span><span class=no>INFO</span><span class=w> </span><span class=n>demo</span>: <span class=nc>something</span><span class=w> </span><span class=n>happened</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>2024</span><span class=o>-</span><span class=mi>07</span><span class=o>-</span><span class=mi>17</span><span class=n>T09</span>:<span class=mi>42</span>:<span class=mf>39.163364</span><span class=n>Z</span><span class=w> </span><span class=no>DEBUG</span><span class=w> </span><span class=n>my_span</span>: <span class=nc>demo</span>: <span class=nc>something</span><span class=w> </span><span class=n>happened</span><span class=w> </span><span class=n>inside</span><span class=w> </span><span class=n>my_span</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>2024</span><span class=o>-</span><span class=mi>07</span><span class=o>-</span><span class=mi>17</span><span class=n>T09</span>:<span class=mi>42</span>:<span class=mf>39.163768</span><span class=n>Z</span><span class=w>  </span><span class=no>INFO</span><span class=w> </span><span class=n>my_span</span>:<span class=nc>span_2</span>: <span class=nc>demo</span>: <span class=nc>something</span><span class=w> </span><span class=n>went</span><span class=w> </span><span class=n>wrong</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=n>my_span</span><span class=w> </span><span class=n>and</span><span class=w> </span><span class=n>span_2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>2024</span><span class=o>-</span><span class=mi>07</span><span class=o>-</span><span class=mi>17</span><span class=n>T09</span>:<span class=mi>42</span>:<span class=mf>39.163974</span><span class=n>Z</span><span class=w>  </span><span class=no>WARN</span><span class=w> </span><span class=n>my_span</span>: <span class=nc>demo</span>: <span class=nc>something</span><span class=w> </span><span class=n>happened</span><span class=w> </span><span class=n>out</span><span class=w> </span><span class=n>of</span><span class=w> </span><span class=n>my_span</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>虽然 event 在哪里都可以使用，但是最好只在 span 的上下文中使用：用于代表一个时间点发生的事件，例如记录 HTTP 请求返回的状态码，从队列中获取一个对象，等等。</p><h2 id=collector-收集器>Collector 收集器<a hidden class=anchor aria-hidden=true href=#collector-收集器>#</a></h2><p>当 Span 或 Event 发生时，它们会被实现了 Collect 特征的收集器所记录或聚合。这个过程是通过通知的方式实现的：当 Event 发生或者 Span 开始/结束时，会调用 Collect 特征的相应方法通知 Collector。</p><h3 id=tracing-subscriber>tracing-subscriber<a hidden class=anchor aria-hidden=true href=#tracing-subscriber>#</a></h3><p>我们前面提到只有使用了 tracing-subscriber 后，日志才能输出到控制台中。</p><p>之前大家可能还不理解，现在应该明白了，它是一个 Collector，可以将记录的日志收集后，再输出到控制台中。</p><h1 id=使用方法>使用方法<a hidden class=anchor aria-hidden=true href=#使用方法>#</a></h1><h2 id=span-宏-跨度-宏>span! 宏 跨度！ 宏<a hidden class=anchor aria-hidden=true href=#span-宏-跨度-宏>#</a></h2><p>span! 宏可以用于创建一个 Span 结构体，然后通过调用结构体的 enter 方法来开始，再通过超出作用域时的 drop 来结束。</p><p>span! 宏可以用于创建一个 Span 结构体，然后通过调用结构体的 enter 方法来开始，再通过超出作用域时的 drop 来结束。
上面span已经给出例子</p><h2 id=instrument>#[instrument]<a hidden class=anchor aria-hidden=true href=#instrument>#</a></h2><p>如果想要将某个函数的整个函数体都设置为 span 的范围，最简单的方法就是为函数标记上 #[instrument]，此时 tracing 会自动为函数创建一个 span，span 名跟函数名相同，在输出的信息中还会自动带上函数参数。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>tracing</span>::<span class=p>{</span><span class=n>info</span><span class=p>,</span><span class=w> </span><span class=n>instrument</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>tracing_subscriber</span>::<span class=p>{</span><span class=n>fmt</span><span class=p>,</span><span class=w> </span><span class=n>layer</span>::<span class=n>SubscriberExt</span><span class=p>,</span><span class=w> </span><span class=n>util</span>::<span class=n>SubscriberInitExt</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[instrument]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>foo</span><span class=p>(</span><span class=n>ans</span>: <span class=kt>i32</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>info!</span><span class=p>(</span><span class=s>&#34;in foo&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>tracing_subscriber</span>::<span class=n>registry</span><span class=p>().</span><span class=n>with</span><span class=p>(</span><span class=n>fmt</span>::<span class=n>layer</span><span class=p>()).</span><span class=n>init</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>foo</span><span class=p>(</span><span class=mi>42</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>output</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=mi>2024</span><span class=o>-</span><span class=mi>07</span><span class=o>-</span><span class=mi>17</span><span class=n>T09</span>:<span class=mi>48</span>:<span class=mf>23.493047</span><span class=n>Z</span><span class=w>  </span><span class=no>INFO</span><span class=w> </span><span class=n>foo</span><span class=p>{</span><span class=n>ans</span><span class=o>=</span><span class=mi>42</span><span class=p>}</span>: <span class=nc>demo</span>: <span class=nc>in</span><span class=w> </span><span class=n>foo</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=in_scope>in_scope<a hidden class=anchor aria-hidden=true href=#in_scope>#</a></h2><p>对于没有内置 tracing 支持或者无法使用 #instrument 的函数，例如外部库的函数，我们可以使用 Span 结构体的 in_scope 方法，它可以将同步代码包裹在一个 span 中：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>tracing</span>::<span class=n>info_span</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>let</span><span class=w> </span><span class=n>json</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=fm>info_span!</span><span class=p>(</span><span class=s>&#34;json.parse&#34;</span><span class=p>).</span><span class=n>in_scope</span><span class=p>(</span><span class=o>||</span><span class=w> </span><span class=n>serde_json</span>::<span class=n>from_slice</span><span class=p>(</span><span class=o>&amp;</span><span class=n>buf</span><span class=p>))</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=在-async-中使用-span>在 async 中使用 span<a hidden class=anchor aria-hidden=true href=#在-async-中使用-span>#</a></h2><p>需要注意，如果是在异步编程时使用，要避免以下使用方式:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>my_async_function</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>span</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=fm>info_span!</span><span class=p>(</span><span class=s>&#34;my_async_function&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// WARNING: 该 span 直到 drop 后才结束，因此在 .await 期间，span 依然处于工作中状态
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>_enter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>span</span><span class=p>.</span><span class=n>enter</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 在这里 span 依然在记录，但是 .await 会让出当前任务的执行权，然后运行时会去运行其它任务，此时这个 span 可能会记录其它任务的执行信息，最终记录了不正确的 trace 信息
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>some_other_async_function</span><span class=p>().</span><span class=k>await</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>建议使用下面的方式，简单有效:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>tracing</span>::<span class=p>{</span><span class=n>info</span><span class=p>,</span><span class=w> </span><span class=n>instrument</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>tokio</span>::<span class=p>{</span><span class=n>io</span>::<span class=n>AsyncWriteExt</span><span class=p>,</span><span class=w> </span><span class=n>net</span>::<span class=n>TcpStream</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>io</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[instrument]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>write</span><span class=p>(</span><span class=n>stream</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>TcpStream</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>io</span>::<span class=nb>Result</span><span class=o>&lt;</span><span class=kt>usize</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>stream</span><span class=p>.</span><span class=n>write</span><span class=p>(</span><span class=sa>b</span><span class=s>&#34;hello world</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>).</span><span class=k>await</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>info!</span><span class=p>(</span><span class=s>&#34;wrote to stream; success={:?}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>result</span><span class=p>.</span><span class=n>is_ok</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>result</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>那有同学可能要问了，是不是我们无法在异步代码中使用 span.enter 了，答案是：是也不是。</p><p>是，你无法直接使用 span.enter 语法了，原因上面也说过，但是可以通过下面的方式来曲线使用：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>tracing</span>::<span class=n>Instrument</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>let</span><span class=w> </span><span class=n>my_future</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>my_future</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>instrument</span><span class=p>(</span><span class=n>tracing</span>::<span class=fm>info_span!</span><span class=p>(</span><span class=s>&#34;my_future&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=k>await</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h1 id=日志初始化写到文件和console-中>日志初始化写到文件和console 中<a hidden class=anchor aria-hidden=true href=#日志初始化写到文件和console-中>#</a></h1><ol><li>在同一个线程中写入到文件</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>tracing</span>::<span class=p>{</span><span class=n>debug</span><span class=p>,</span><span class=w> </span><span class=n>error</span><span class=p>,</span><span class=w> </span><span class=n>event</span><span class=p>,</span><span class=w> </span><span class=n>info</span><span class=p>,</span><span class=w> </span><span class=n>Level</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>tracing_appender</span>::<span class=n>rolling</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>tracing_subscriber</span>::<span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>filter</span><span class=p>,</span><span class=w> </span><span class=n>fmt</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>fmt</span>::<span class=p>{</span><span class=n>format</span>::<span class=n>Writer</span><span class=p>,</span><span class=w> </span><span class=n>time</span>::<span class=n>FormatTime</span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>layer</span>::<span class=n>SubscriberExt</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>registry</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>util</span>::<span class=n>SubscriberInitExt</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Layer</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 用来格式化日志的输出时间格式
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>struct</span> <span class=nc>LocalTimer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// // 注意，使用chrono::Local::now()的效率相对会差一些，因为每次获取时间都要探测本机的时区。因此可改进为使用Offset的方式，明确指定时区，无需探测：
</span></span></span><span class=line><span class=cl><span class=c1>// impl FormatTime for LocalTimer {
</span></span></span><span class=line><span class=cl><span class=c1>//     fn format_time(&amp;self, w: &amp;mut Writer&lt;&#39;_&gt;) -&gt; std::fmt::Result {
</span></span></span><span class=line><span class=cl><span class=c1>//         write!(w, &#34;{}&#34;, chrono::Local::now().format(&#34;%FT%T%.3f&#34;))
</span></span></span><span class=line><span class=cl><span class=c1>//     }
</span></span></span><span class=line><span class=cl><span class=c1>// }
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>const</span><span class=w> </span><span class=k>fn</span> <span class=nf>east8</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nb>Option</span><span class=o>&lt;</span><span class=n>chrono</span>::<span class=n>FixedOffset</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>chrono</span>::<span class=n>FixedOffset</span>::<span class=n>east_opt</span><span class=p>(</span><span class=mi>8</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>3600</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>impl</span><span class=w> </span><span class=n>FormatTime</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>LocalTimer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>format_time</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>w</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>Writer</span><span class=o>&lt;</span><span class=nb>&#39;_</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>std</span>::<span class=n>fmt</span>::<span class=nb>Result</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>now</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>chrono</span>::<span class=n>Utc</span>::<span class=n>now</span><span class=p>().</span><span class=n>with_timezone</span><span class=p>(</span><span class=o>&amp;</span><span class=n>east8</span><span class=p>().</span><span class=n>unwrap</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=fm>write!</span><span class=p>(</span><span class=n>w</span><span class=p>,</span><span class=w> </span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>now</span><span class=p>.</span><span class=n>format</span><span class=p>(</span><span class=s>&#34;%FT%T%.3f&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>logger_init</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 文件输出层
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>file_appender</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rolling</span>::<span class=n>daily</span><span class=p>(</span><span class=s>&#34;logs/&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;log&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// let (non_blocking_appender, _guard) = non_blocking(file_appender); // 输出非阻塞
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>registry</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// first layer for console output, use pretty formatter and level filter
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=p>.</span><span class=n>with</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>fmt</span>::<span class=n>layer</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=n>with_timer</span><span class=p>(</span><span class=n>LocalTimer</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=n>pretty</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=n>with_filter</span><span class=p>(</span><span class=n>filter</span>::<span class=n>LevelFilter</span>::<span class=n>from</span><span class=p>(</span><span class=n>Level</span>::<span class=no>WARN</span><span class=p>)),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// second layer for log file appender, use json formatter, no filter
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=p>.</span><span class=n>with</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>fmt</span>::<span class=n>layer</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=n>with_timer</span><span class=p>(</span><span class=n>LocalTimer</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=n>with_ansi</span><span class=p>(</span><span class=kc>false</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=n>json</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=n>with_writer</span><span class=p>(</span><span class=n>file_appender</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=n>with_filter</span><span class=p>(</span><span class=n>filter</span>::<span class=n>LevelFilter</span>::<span class=n>from_level</span><span class=p>(</span><span class=n>Level</span>::<span class=no>INFO</span><span class=p>)),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>init</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// _guard
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// tracing_subscriber::fmt::init();
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>logger_init</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>event!</span><span class=p>(</span><span class=n>Level</span>::<span class=no>INFO</span><span class=p>,</span><span class=w> </span><span class=n>passwd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;passwd&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>foo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>42</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>info!</span><span class=p>(</span><span class=n>foo</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Hello from tracing&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>debug!</span><span class=p>(</span><span class=n>foo</span><span class=p>,</span><span class=w> </span><span class=s>&#34;hello at debug level&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>error!</span><span class=p>(</span><span class=n>foo</span><span class=p>,</span><span class=w> </span><span class=s>&#34;error will be in file&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>cargo.toml</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[</span><span class=nx>dependencies</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>tracing</span> <span class=p>=</span> <span class=s2>&#34;0.1.37&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>tracing-subscriber</span> <span class=p>=</span> <span class=p>{</span> <span class=nx>version</span> <span class=p>=</span> <span class=s2>&#34;0.3.16&#34;</span><span class=p>,</span> <span class=nx>features</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;json&#34;</span><span class=p>]</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>tracing-appender</span> <span class=p>=</span> <span class=s2>&#34;0.2&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>chrono</span> <span class=p>=</span> <span class=s2>&#34;0.4&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>当然，还有其它一些方式设置tracing-subscriber日志时间的时区和格式。例如可以通过它的fmt::time::OffsetTime指定时区，不过它使用的是time crate，因此如果记录非UTC时区，则先设置Cargo.toml：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=nx>tracing-subscriber</span> <span class=p>=</span> <span class=p>{</span><span class=nx>version</span> <span class=p>=</span> <span class=s2>&#34;0.3&#34;</span><span class=p>,</span> <span class=nx>features</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;time&#34;</span><span class=p>]}</span>
</span></span><span class=line><span class=cl><span class=nx>time</span> <span class=p>=</span> <span class=p>{</span> <span class=nx>version</span> <span class=p>=</span> <span class=s2>&#34;0.3&#34;</span><span class=p>,</span> <span class=nx>features</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;macros&#34;</span><span class=p>]</span> <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>time</span>::<span class=n>macros</span>::<span class=p>{</span><span class=n>format_description</span><span class=p>,</span><span class=w> </span><span class=n>offset</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>tracing_subscriber</span>::<span class=n>fmt</span>::<span class=n>time</span>::<span class=n>OffsetTime</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>time_fmt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=fm>format_description!</span><span class=p>(</span><span class=s>&#34;[year]-[month]-[day]T[hour]:[minute]:[second].[subsecond digits:3]&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>timer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>OffsetTime</span>::<span class=n>new</span><span class=p>(</span><span class=fm>offset!</span><span class=p>(</span><span class=o>+</span><span class=mi>8</span><span class=p>),</span><span class=w> </span><span class=n>time_fmt</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>tracing_subscriber</span>::<span class=n>fmt</span><span class=p>().</span><span class=n>with_timer</span><span class=p>(</span><span class=n>timer</span><span class=p>).</span><span class=n>init</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>offset</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>tracing</span>::<span class=fm>info!</span><span class=p>(</span><span class=s>&#34;offset: {}, hello world&#34;</span><span class=p>,</span><span class=w> </span><span class=n>offset</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ol start=2><li>使用非阻塞输出</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>tracing</span>::<span class=p>{</span><span class=n>debug</span><span class=p>,</span><span class=w> </span><span class=n>error</span><span class=p>,</span><span class=w> </span><span class=n>event</span><span class=p>,</span><span class=w> </span><span class=n>info</span><span class=p>,</span><span class=w> </span><span class=n>Level</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>tracing_appender</span>::<span class=n>non_blocking</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>tracing_appender</span>::<span class=n>rolling</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>tracing_subscriber</span>::<span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>filter</span><span class=p>,</span><span class=w> </span><span class=n>fmt</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>fmt</span>::<span class=p>{</span><span class=n>format</span>::<span class=n>Writer</span><span class=p>,</span><span class=w> </span><span class=n>time</span>::<span class=n>FormatTime</span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>layer</span>::<span class=n>SubscriberExt</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>registry</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>util</span>::<span class=n>SubscriberInitExt</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Layer</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 用来格式化日志的输出时间格式
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>struct</span> <span class=nc>LocalTimer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// // 注意，使用chrono::Local::now()的效率相对会差一些，因为每次获取时间都要探测本机的时区。因此可改进为使用Offset的方式，明确指定时区，无需探测：
</span></span></span><span class=line><span class=cl><span class=c1>// impl FormatTime for LocalTimer {
</span></span></span><span class=line><span class=cl><span class=c1>//     fn format_time(&amp;self, w: &amp;mut Writer&lt;&#39;_&gt;) -&gt; std::fmt::Result {
</span></span></span><span class=line><span class=cl><span class=c1>//         write!(w, &#34;{}&#34;, chrono::Local::now().format(&#34;%FT%T%.3f&#34;))
</span></span></span><span class=line><span class=cl><span class=c1>//     }
</span></span></span><span class=line><span class=cl><span class=c1>// }
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>const</span><span class=w> </span><span class=k>fn</span> <span class=nf>east8</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nb>Option</span><span class=o>&lt;</span><span class=n>chrono</span>::<span class=n>FixedOffset</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>chrono</span>::<span class=n>FixedOffset</span>::<span class=n>east_opt</span><span class=p>(</span><span class=mi>8</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>3600</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>impl</span><span class=w> </span><span class=n>FormatTime</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>LocalTimer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>format_time</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>w</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>Writer</span><span class=o>&lt;</span><span class=nb>&#39;_</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>std</span>::<span class=n>fmt</span>::<span class=nb>Result</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>now</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>chrono</span>::<span class=n>Utc</span>::<span class=n>now</span><span class=p>().</span><span class=n>with_timezone</span><span class=p>(</span><span class=o>&amp;</span><span class=n>east8</span><span class=p>().</span><span class=n>unwrap</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=fm>write!</span><span class=p>(</span><span class=n>w</span><span class=p>,</span><span class=w> </span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>now</span><span class=p>.</span><span class=n>format</span><span class=p>(</span><span class=s>&#34;%FT%T%.3f&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>logger_init</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>non_blocking</span>::<span class=n>WorkerGuard</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 文件输出层
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>file_appender</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rolling</span>::<span class=n>daily</span><span class=p>(</span><span class=s>&#34;logs/&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;log&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=p>(</span><span class=n>non_blocking_appender</span><span class=p>,</span><span class=w> </span><span class=n>_guard</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>non_blocking</span><span class=p>(</span><span class=n>file_appender</span><span class=p>);</span><span class=w> </span><span class=c1>// 输出非阻塞
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>registry</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// first layer for console output, use pretty formatter and level filter
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=p>.</span><span class=n>with</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>fmt</span>::<span class=n>layer</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=n>with_timer</span><span class=p>(</span><span class=n>LocalTimer</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=n>pretty</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=n>with_filter</span><span class=p>(</span><span class=n>filter</span>::<span class=n>LevelFilter</span>::<span class=n>from</span><span class=p>(</span><span class=n>Level</span>::<span class=no>WARN</span><span class=p>)),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// second layer for log file appender, use json formatter, no filter
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=p>.</span><span class=n>with</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>fmt</span>::<span class=n>layer</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=n>with_timer</span><span class=p>(</span><span class=n>LocalTimer</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=n>with_ansi</span><span class=p>(</span><span class=kc>false</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=n>json</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=n>with_writer</span><span class=p>(</span><span class=n>non_blocking_appender</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=n>with_filter</span><span class=p>(</span><span class=n>filter</span>::<span class=n>LevelFilter</span>::<span class=n>from_level</span><span class=p>(</span><span class=n>Level</span>::<span class=no>INFO</span><span class=p>)),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>init</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>_guard</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 需注意，使用tracing_appender时，因为是先缓冲日志信息，而不是直接写入文件。他要求必须在main()函数中使用Guard，否则guard被丢弃将不会写入任何信息到文件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>_g</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>logger_init</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>event!</span><span class=p>(</span><span class=n>Level</span>::<span class=no>INFO</span><span class=p>,</span><span class=w> </span><span class=n>passwd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;passwd&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>foo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>42</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>info!</span><span class=p>(</span><span class=n>foo</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Hello from tracing&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>debug!</span><span class=p>(</span><span class=n>foo</span><span class=p>,</span><span class=w> </span><span class=s>&#34;hello at debug level&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>error!</span><span class=p>(</span><span class=n>foo</span><span class=p>,</span><span class=w> </span><span class=s>&#34;error will be in file&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://reid00.github.io/en/tags/rust/>Rust</a></li><li><a href=https://reid00.github.io/en/tags/log/>Log</a></li><li><a href=https://reid00.github.io/en/tags/tracing/>Tracing</a></li></ul><nav class=paginav><a class=prev href=https://reid00.github.io/en/posts/other/%E5%AE%B6%E5%BA%ADmesh%E7%BB%84%E7%BD%91%E8%A7%84%E5%88%92/><span class=title>« Prev</span><br><span>家庭mesh组网规划</span>
</a><a class=next href=https://reid00.github.io/en/posts/algo/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92%E4%B9%8B01%E8%83%8C%E5%8C%85%E9%97%AE%E9%A2%98/><span class=title>Next »</span><br><span>动态规划之01背包问题</span></a></nav></footer><script src=https://utteranc.es/client.js repo=Reid00/hugo-blog-talks issue-term=pathname label=Comment theme=github-light crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2024 <a href=https://reid00.github.io/en/>Reid's Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>