<!doctype html><html lang=en dir=auto><head><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta name=referrer content="no-referrer-when-downgrade"></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://reid00.github.io/en/ accesskey=h title="Reid's Blog (Alt + H)">Reid's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://reid00.github.io/en/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://reid00.github.io/en/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://reid00.github.io/en/categories/ title=Categorys><span>Categorys</span></a></li><li><a href=https://reid00.github.io/en/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://reid00.github.io/en/>Home</a>&nbsp;»&nbsp;<a href=https://reid00.github.io/en/posts/>Posts</a>&nbsp;»&nbsp;<a href=https://reid00.github.io/en/posts/storage/>存储, 分布式相关的文章</a></div><h1 class=post-title>MIT6.824 2022 Raft Lab2A Leader Election</h1><div class=post-description>MIT6.824 2022 Raft Lab2A Leader Election</div><div class=post-meta><span title='2023-03-16 19:34:55 +0800 +0800'>2023-03-16 19:34</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;1023 words&nbsp;·&nbsp;Reid</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e4%bb%8b%e7%bb%8d aria-label=介绍>介绍</a></li><li><a href=#%e6%b5%81%e7%a8%8b%e6%a2%b3%e7%90%86 aria-label=流程梳理>流程梳理</a></li><li><a href=#%e6%9c%8d%e5%8a%a1%e5%99%a8%e7%8a%b6%e6%80%81 aria-label=服务器状态>服务器状态</a></li><li><a href=#%e5%90%af%e5%8a%a8 aria-label=启动>启动</a></li><li><a href=#%e9%80%89%e4%b8%be%e4%b8%8e%e6%8a%95%e7%a5%a8 aria-label=选举与投票>选举与投票</a></li><li><a href=#requestvote aria-label=RequestVote>RequestVote</a></li><li><a href=#%e6%80%bb%e7%bb%93 aria-label=总结>总结</a></li></ul></div></details></div><div class=post-content><h2 id=介绍>介绍<a hidden class=anchor aria-hidden=true href=#介绍>#</a></h2><ul><li><a href=https://reid00.github.io/en/posts/storage/raft-%E4%BB%8B%E7%BB%8D/>查看Raft0</a></li></ul><h2 id=流程梳理>流程梳理<a hidden class=anchor aria-hidden=true href=#流程梳理>#</a></h2><p>整体逻辑, 从 <code>ticker</code> goroutine 开始, 集群开始的时候，所有节点均为Follower， 它们依靠ticker()成为<code>Candidate</code>。<code>ticker</code> 协程会定期收到两个 timer 的到期事件，如果是 election timer 到期，则发起一轮选举；如果是 heartbeat timer 到期且节点是 leader，则发起一轮心跳。</p><p><code>ElectionTimer</code> 和 <code>HeartbeatTimer</code>. 如果某个raft 节点election timeout,则会触发leader election, 调用<code>StartElection</code> 方法。 <code>StartElection</code> 中发送 <code>RequestVote RPC</code>, 根据ReqestVote Response 判断是否收到选票,决定是否成为<code>Leader</code>。</p><p>如果某个节点,收到大多数节点的选票,成为<code>Leader</code> 要通过发送<code>Heartbeat</code> 即空LogEntry 的<code>AppendEntries RPC</code> 来告诉其他节点自己的 <code>Leader</code> 地位。</p><p>所以Lab2A 中,主要实现 <code>RequestVote</code>, <code>AppendEntries</code> 的逻辑。</p><h2 id=服务器状态>服务器状态<a hidden class=anchor aria-hidden=true href=#服务器状态>#</a></h2><p>服务器在任意时间只能处于以下三种状态之一：</p><ul><li><code>Leader</code>：处理所有客户端请求、日志同步、心跳维持领导权。同一时刻最多只能有一个可行的 Leader</li><li><code>Follower</code>：所有服务器的初始状态，功能为：追随领导者，接收领导者日志并实时同步，特性：完全被动的（不发送 RPC，只响应收到的 RPC）</li><li><code>Candidate</code>：用来选举新的 Leader，处于 Leader 和 Follower 之间的暂时状态，如Follower 一定时间内未收到来自Leader的心跳包，Follower会自动切换为Candidate，并开始选举操作，向集群中的其它节点发送投票请求，待收到半数以上的选票时，协调者升级成为领导者。</li></ul><p>系统正常运行时，只有一个 Leader，其余都是 Followers。Leader拥有绝对的领导力，不断向Followers同步日志且发送心跳状态。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Raft</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>mu</span>        <span class=nx>sync</span><span class=p>.</span><span class=nx>RWMutex</span>        <span class=c1>// Lock to protect shared access to this peer&#39;s state
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>peers</span>     <span class=p>[]</span><span class=o>*</span><span class=nx>labrpc</span><span class=p>.</span><span class=nx>ClientEnd</span> <span class=c1>// RPC end points of all peers
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>persister</span> <span class=o>*</span><span class=nx>Persister</span>          <span class=c1>// Object to hold this peer&#39;s persisted state
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>me</span>        <span class=kt>int</span>                 <span class=c1>// this peer&#39;s index into peers[]
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>dead</span>      <span class=kt>int32</span>               <span class=c1>// set by Kill()
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// Your data here (2A, 2B, 2C).
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// Look at the paper&#39;s Figure 2 for a description of what
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// state a Raft server must maintain.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// 2A
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>state</span>          <span class=nx>NodeState</span>
</span></span><span class=line><span class=cl>	<span class=nx>currentTerm</span>    <span class=kt>int</span>
</span></span><span class=line><span class=cl>	<span class=nx>votedFor</span>       <span class=kt>int</span>
</span></span><span class=line><span class=cl>	<span class=nx>electionTimer</span>  <span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Timer</span>
</span></span><span class=line><span class=cl>	<span class=nx>heartbeatTimer</span> <span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Timer</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 2B
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>logs</span>        <span class=p>[]</span><span class=nx>Entry</span> <span class=c1>// the first is dummy entry which contains LastSnapshotTerm, LastSnapshotIndex and nil Command
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>commitIndex</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl>	<span class=nx>lastApplied</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl>	<span class=nx>nextIndex</span>   <span class=p>[]</span><span class=kt>int</span>
</span></span><span class=line><span class=cl>	<span class=nx>matchIndex</span>  <span class=p>[]</span><span class=kt>int</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>applyCh</span>        <span class=kd>chan</span> <span class=nx>ApplyMsg</span>
</span></span><span class=line><span class=cl>	<span class=nx>applyCond</span>      <span class=o>*</span><span class=nx>sync</span><span class=p>.</span><span class=nx>Cond</span>   <span class=c1>// used to wakeup applier goroutine after committing new entries
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>replicatorCond</span> <span class=p>[]</span><span class=o>*</span><span class=nx>sync</span><span class=p>.</span><span class=nx>Cond</span> <span class=c1>// used to signal replicator goroutine to batch replicating entries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=启动>启动<a hidden class=anchor aria-hidden=true href=#启动>#</a></h2><ul><li>集群所有节点初始状态均为Follower</li><li>Follower 被动地接受 Leader 或 Candidate 的 RPC；</li><li>所以，如果 Leader 想要保持权威，必须向集群中的其它节点发送心跳包（空的 <code>AppendEntries</code> RPC）</li><li>等待选举超时(electionTimeout，一般在 100~500ms)后，Follower 没有收到任何 RPC</li><li>Follower 认为集群中没有 Leader</li><li>开始新的一轮选举</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Make</span><span class=p>(</span><span class=nx>peers</span> <span class=p>[]</span><span class=o>*</span><span class=nx>labrpc</span><span class=p>.</span><span class=nx>ClientEnd</span><span class=p>,</span> <span class=nx>me</span> <span class=kt>int</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>persister</span> <span class=o>*</span><span class=nx>Persister</span><span class=p>,</span> <span class=nx>applyCh</span> <span class=kd>chan</span> <span class=nx>ApplyMsg</span><span class=p>)</span> <span class=o>*</span><span class=nx>Raft</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>rf</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>Raft</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>peers</span><span class=p>:</span>          <span class=nx>peers</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>persister</span><span class=p>:</span>      <span class=nx>persister</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>me</span><span class=p>:</span>             <span class=nx>me</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>dead</span><span class=p>:</span>           <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>applyCh</span><span class=p>:</span>        <span class=nx>applyCh</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>replicatorCond</span><span class=p>:</span> <span class=nb>make</span><span class=p>([]</span><span class=o>*</span><span class=nx>sync</span><span class=p>.</span><span class=nx>Cond</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>peers</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>		<span class=nx>state</span><span class=p>:</span>          <span class=nx>StateFollower</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>currentTerm</span><span class=p>:</span>    <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>votedFor</span><span class=p>:</span>       <span class=o>-</span><span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>logs</span><span class=p>:</span>           <span class=nb>make</span><span class=p>([]</span><span class=nx>Entry</span><span class=p>,</span> <span class=mi>1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>nextIndex</span><span class=p>:</span>      <span class=nb>make</span><span class=p>([]</span><span class=kt>int</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>peers</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>		<span class=nx>matchIndex</span><span class=p>:</span>     <span class=nb>make</span><span class=p>([]</span><span class=kt>int</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>peers</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>		<span class=nx>heartbeatTimer</span><span class=p>:</span> <span class=nx>time</span><span class=p>.</span><span class=nf>NewTimer</span><span class=p>(</span><span class=nf>StableHeartbeatTimeout</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>		<span class=nx>electionTimer</span><span class=p>:</span>  <span class=nx>time</span><span class=p>.</span><span class=nf>NewTimer</span><span class=p>(</span><span class=nf>RandomizedElectionTimeout</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Your initialization code here (2A, 2B, 2C).
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// initialize from state persisted before a crash
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>rf</span><span class=p>.</span><span class=nf>readPersist</span><span class=p>(</span><span class=nx>persister</span><span class=p>.</span><span class=nf>ReadRaftState</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>rf</span><span class=p>.</span><span class=nx>applyCond</span> <span class=p>=</span> <span class=nx>sync</span><span class=p>.</span><span class=nf>NewCond</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>lastLog</span> <span class=o>:=</span> <span class=nx>rf</span><span class=p>.</span><span class=nf>getLastLog</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=nx>peers</span><span class=p>);</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>rf</span><span class=p>.</span><span class=nx>matchIndex</span><span class=p>[</span><span class=nx>i</span><span class=p>],</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>nextIndex</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=p>=</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>lastLog</span><span class=p>.</span><span class=nx>Index</span><span class=o>+</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>i</span> <span class=o>!=</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>me</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>rf</span><span class=p>.</span><span class=nx>replicatorCond</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=p>=</span> <span class=nx>sync</span><span class=p>.</span><span class=nf>NewCond</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>			<span class=c1>// start replicator goroutine to replicate entries in batch
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>go</span> <span class=nx>rf</span><span class=p>.</span><span class=nf>replicator</span><span class=p>(</span><span class=nx>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// start ticker goroutine to start elections
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>go</span> <span class=nx>rf</span><span class=p>.</span><span class=nf>ticker</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// start applier goroutine to push committed logs into applyCh exactly once
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>go</span> <span class=nx>rf</span><span class=p>.</span><span class=nf>applier</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>rf</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>集群开始的时候，所有节点均为Follower， 它们依靠ticker()成为Candidate。ticker 协程会定期收到两个 timer 的到期事件，如果是 election timer 到期，则发起一轮选举；如果是 heartbeat timer 到期且节点是 leader，则发起一轮心跳。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// ticker The ticker go routine starts a new election if this peer hasn&#39;t received
</span></span></span><span class=line><span class=cl><span class=c1>// heartsbeats recently.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>rf</span> <span class=o>*</span><span class=nx>Raft</span><span class=p>)</span> <span class=nf>ticker</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// for rf.killed() == false {
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>for</span> <span class=p>!</span><span class=nx>rf</span><span class=p>.</span><span class=nf>killed</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// Your code here to check if a leader election should
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// be started and to randomize sleeping time using
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// time.Sleep().
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>rf</span><span class=p>.</span><span class=nx>electionTimer</span><span class=p>.</span><span class=nx>C</span><span class=p>:</span> <span class=c1>// start election
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nf>DPrintf</span><span class=p>(</span><span class=s>&#34;{Node: %v} election timeout&#34;</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>me</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=nx>rf</span><span class=p>.</span><span class=nf>ChangeState</span><span class=p>(</span><span class=nx>StateCandidate</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>			<span class=nx>rf</span><span class=p>.</span><span class=nf>StartElection</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=nx>rf</span><span class=p>.</span><span class=nx>electionTimer</span><span class=p>.</span><span class=nf>Reset</span><span class=p>(</span><span class=nf>RandomizedElectionTimeout</span><span class=p>())</span>
</span></span><span class=line><span class=cl>			<span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>rf</span><span class=p>.</span><span class=nx>heartbeatTimer</span><span class=p>.</span><span class=nx>C</span><span class=p>:</span> <span class=c1>// 领导者发送心跳维持领导力, 2A 可以先不实现
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>state</span> <span class=o>==</span> <span class=nx>StateLeader</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>rf</span><span class=p>.</span><span class=nf>BroadcastHeartbeat</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=nx>rf</span><span class=p>.</span><span class=nx>heartbeatTimer</span><span class=p>.</span><span class=nf>Reset</span><span class=p>(</span><span class=nf>StableHeartbeatTimeout</span><span class=p>())</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=选举与投票>选举与投票<a hidden class=anchor aria-hidden=true href=#选举与投票>#</a></h2><p>当一个节点开始竞选：</p><ol><li>增加自己的 <code>currentTerm</code></li><li>转为 <code>Candidate</code> 状态，其目标是获取超过半数节点的选票，让自己成为 Leader</li><li>先给自己投一票</li><li>并行地向集群中其它节点发送<code> RequestVote RPC</code> 索要选票，如果没有收到指定节点的响应，它会反复尝试，直到发生以下三种情况之一:<ul><li>获得超过半数的选票：成为 <code>Leader</code>，并向其它节点发送 <code>AppendEntries</code> 心跳；</li><li>收到来自 <code>Leader</code> 的 RPC：转为 <code>Follower；</code></li><li>其它两种情况都没发生，没人能够获胜(electionTimeout 已过)：增加 <code>currentTerm</code>，开始新一轮选举；</li></ul></li></ol><p><code>Candidate</code> 选举程序与投票统计</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nf>unc</span> <span class=p>(</span><span class=nx>rf</span> <span class=o>*</span><span class=nx>Raft</span><span class=p>)</span> <span class=nf>StartElection</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>req</span> <span class=o>:=</span> <span class=nx>rf</span><span class=p>.</span><span class=nf>genRequestVoteReq</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nf>DPrintf</span><span class=p>(</span><span class=s>&#34;{Note: %v} starts election with RequestVoteReq: %v&#34;</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>me</span><span class=p>,</span> <span class=nx>req</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Closure
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>grantedVote</span> <span class=o>:=</span> <span class=mi>1</span> <span class=c1>// elect for itself
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>rf</span><span class=p>.</span><span class=nx>votedFor</span> <span class=p>=</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>me</span>
</span></span><span class=line><span class=cl>	<span class=nx>rf</span><span class=p>.</span><span class=nf>persist</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>peer</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>peers</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>peer</span> <span class=o>==</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>me</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>continue</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>go</span> <span class=kd>func</span><span class=p>(</span><span class=nx>peer</span> <span class=kt>int</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>resp</span> <span class=o>:=</span> <span class=nb>new</span><span class=p>(</span><span class=nx>RequestVoteResponse</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>rf</span><span class=p>.</span><span class=nf>sendRequestVote</span><span class=p>(</span><span class=nx>peer</span><span class=p>,</span> <span class=nx>req</span><span class=p>,</span> <span class=nx>resp</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>				<span class=k>defer</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>				<span class=nf>DPrintf</span><span class=p>(</span><span class=s>&#34;[RequestVoteResp]-{Node: %v} receives RequestVoteResponse %v from {Node: %v} after sending RequestVoteRequest %v in term %v&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=nx>rf</span><span class=p>.</span><span class=nx>me</span><span class=p>,</span> <span class=nx>resp</span><span class=p>,</span> <span class=nx>peer</span><span class=p>,</span> <span class=nx>req</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>				<span class=c1>// rf.currentTerm == req.Term 为了抛弃过期的RequestVote RPC
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=k>if</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span> <span class=o>==</span> <span class=nx>req</span><span class=p>.</span><span class=nx>Term</span> <span class=o>&amp;&amp;</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>state</span> <span class=o>==</span> <span class=nx>StateCandidate</span> <span class=p>{</span> <span class=c1>// Candidate node
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=k>if</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>VoteGranted</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nx>grantedVote</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>						<span class=k>if</span> <span class=nx>grantedVote</span> <span class=p>&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=nx>rf</span><span class=p>.</span><span class=nx>peers</span><span class=p>)</span><span class=o>/</span><span class=mi>2</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>							<span class=nf>DPrintf</span><span class=p>(</span><span class=s>&#34;{Node: %v} receives majority votes in term %v&#34;</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>me</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>							<span class=nx>rf</span><span class=p>.</span><span class=nf>ChangeState</span><span class=p>(</span><span class=nx>StateLeader</span><span class=p>)</span>
</span></span><span class=line><span class=cl>							<span class=nx>rf</span><span class=p>.</span><span class=nf>BroadcastHeartbeat</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>						<span class=p>}</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>Term</span> <span class=p>&gt;</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=c1>// candidate 发现有term 比自己大的，立刻转为follower
</span></span></span><span class=line><span class=cl><span class=c1></span>						<span class=nf>DPrintf</span><span class=p>(</span><span class=s>&#34;{Node %v} finds a new leader {Node %v} with term %v and steps down in term %v&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>							<span class=nx>rf</span><span class=p>.</span><span class=nx>me</span><span class=p>,</span> <span class=nx>peer</span><span class=p>,</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>Term</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>						<span class=nx>rf</span><span class=p>.</span><span class=nf>ChangeState</span><span class=p>(</span><span class=nx>StateFollower</span><span class=p>)</span>
</span></span><span class=line><span class=cl>						<span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>votedFor</span> <span class=p>=</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>Term</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>						<span class=nx>rf</span><span class=p>.</span><span class=nf>persist</span><span class=p>()</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}(</span><span class=nx>peer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>发起投票需要异步进行，从而不阻塞ticker线程，这样candidate 再次 election timeout 之后才能自增 term 继续发起新一轮选举。</li><li>投票统计：可以在函数内定义一个变量并利用 go 的闭包来实现，也可以在结构体中维护一个 votes 变量来实现。为了 raft 结构体更干净，我选择了前者。</li><li>抛弃过期请求的回复：对于过期请求的回复，直接抛弃就行，不要做任何处理，这一点 guidance 里面也有介绍到</li></ul><h2 id=requestvote>RequestVote<a hidden class=anchor aria-hidden=true href=#requestvote>#</a></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>rf</span> <span class=o>*</span><span class=nx>Raft</span><span class=p>)</span> <span class=nf>RequestVote</span><span class=p>(</span><span class=nx>req</span> <span class=o>*</span><span class=nx>RequestVoteRequest</span><span class=p>,</span> <span class=nx>resp</span> <span class=o>*</span><span class=nx>RequestVoteResponse</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Your code here (2A, 2B).
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// 2A
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>rf</span><span class=p>.</span><span class=nf>persist</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nf>DPrintf</span><span class=p>(</span><span class=s>&#34;[RequestVote]-{Node %v}&#39;s state is {state %v,term %v,commitIndex %v,lastApplied %v,firstLog %v,lastLog %v} before processing requestVoteRequest %v and reply requestVoteResponse %v&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>rf</span><span class=p>.</span><span class=nx>me</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>state</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>commitIndex</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>lastApplied</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nf>getFirstLog</span><span class=p>(),</span> <span class=nx>rf</span><span class=p>.</span><span class=nf>getLastLog</span><span class=p>(),</span> <span class=nx>req</span><span class=p>,</span> <span class=nx>resp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>req</span><span class=p>.</span><span class=nx>Term</span> <span class=p>&lt;</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span> <span class=o>||</span> <span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>Term</span> <span class=o>==</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span> <span class=o>&amp;&amp;</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>votedFor</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span> <span class=o>&amp;&amp;</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>votedFor</span> <span class=o>!=</span> <span class=nx>req</span><span class=p>.</span><span class=nx>CandidateId</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>resp</span><span class=p>.</span><span class=nx>Term</span><span class=p>,</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>VoteGranted</span> <span class=p>=</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=p>,</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>req</span><span class=p>.</span><span class=nx>Term</span> <span class=p>&gt;</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>rf</span><span class=p>.</span><span class=nf>ChangeState</span><span class=p>(</span><span class=nx>StateFollower</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>votedFor</span> <span class=p>=</span> <span class=nx>req</span><span class=p>.</span><span class=nx>Term</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 2A 可以先不实现
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=p>!</span><span class=nx>rf</span><span class=p>.</span><span class=nf>isLogUpToDate</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>LastLogTerm</span><span class=p>,</span> <span class=nx>req</span><span class=p>.</span><span class=nx>LastLogIndex</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>resp</span><span class=p>.</span><span class=nx>Term</span><span class=p>,</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>VoteGranted</span> <span class=p>=</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=p>,</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>rf</span><span class=p>.</span><span class=nx>votedFor</span> <span class=p>=</span> <span class=nx>req</span><span class=p>.</span><span class=nx>CandidateId</span>
</span></span><span class=line><span class=cl>	<span class=nx>rf</span><span class=p>.</span><span class=nx>electionTimer</span><span class=p>.</span><span class=nf>Reset</span><span class=p>(</span><span class=nf>RandomizedElectionTimeout</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=nx>resp</span><span class=p>.</span><span class=nx>Term</span><span class=p>,</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>VoteGranted</span> <span class=p>=</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=p>,</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>「任期」表示节点的逻辑时钟，任期高的节点拥有更高的话语权。在<code>RequestVote</code>这个函数中，如果请求者的任期小于当前节点任期，则拒绝投票；如果请求者任期大于当前节点人气，那么当前节点立马成为追随者。即任期大的节点对任期小的拥有绝对的话语权，一旦发现任期大的节点，立马成为其追随者。</p><p>注意，节点的选举随机时间和心跳时间的选择很重要</p><ul><li>节点随机选择超时时间，通常在 [T, 2T] 之间（T = electionTimeout）</li><li>这样，节点不太可能再同时开始竞选，先竞选的节点有足够的时间来索要其他节点的选票</li><li>T &#187; broadcast time(T 远大于广播时间)时效果更佳</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>HeartbeatTimeout</span> <span class=p>=</span> <span class=mi>125</span>
</span></span><span class=line><span class=cl>	<span class=nx>ElectionTimeout</span>  <span class=p>=</span> <span class=mi>1000</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>StableHeartbeatTimeout</span><span class=p>()</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// return time.Duration(HeartbeatTimeout) * time.Millisecond
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>return</span> <span class=nx>HeartbeatTimeout</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>RandomizedElectionTimeout</span><span class=p>()</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=nx>ElectionTimeout</span><span class=o>+</span><span class=nx>globalRand</span><span class=p>.</span><span class=nf>Intn</span><span class=p>(</span><span class=nx>ElectionTimeout</span><span class=p>))</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=总结>总结<a hidden class=anchor aria-hidden=true href=#总结>#</a></h2><p>领导者选举主要工作可总结如下：</p><ul><li>三个状态，三个状态之间的转换。</li><li>1个loop——ticker。</li><li>1个RPC请求和处理，用于投票。</li></ul><p>另外，ticker会一直运行，直到节点被kill，因此集群领导者并非唯一，一旦领导者出现了宕机、网络故障等问题，其它节点都能第一时间感知，并迅速做出重新选举的反应，从而维持集群的正常运行，毕竟Raft集群一旦失去了领导者，就无法工作。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://reid00.github.io/en/tags/raft/>Raft</a></li><li><a href=https://reid00.github.io/en/tags/mit6.824/>MIT6.824</a></li><li><a href=https://reid00.github.io/en/tags/consensus/>Consensus</a></li><li><a href=https://reid00.github.io/en/tags/%E5%85%B1%E8%AF%86%E7%AE%97%E6%B3%95/>共识算法</a></li></ul><nav class=paginav><a class=prev href=https://reid00.github.io/en/posts/storage/mit6.824-2022-raft-0-%E4%BB%8B%E7%BB%8D/><span class=title>« Prev</span><br><span>MIT6.824 2022 Raft 0 介绍</span>
</a><a class=next href=https://reid00.github.io/en/posts/storage/mit6.824-2022-raft-lab2b-log-replication/><span class=title>Next »</span><br><span>MIT6.824 2022 Raft Lab2B Log Replication</span></a></nav></footer><script src=https://utteranc.es/client.js repo=Reid00/hugo-blog-talks issue-term=pathname label=Comment theme=github-light crossorigin=anonymous async></script></article></main><span id=busuanzi_container_site_pv>访问量<span id=busuanzi_value_site_pv></span>次
</span><span id=busuanzi_container_site_uv>访客数<span id=busuanzi_value_site_uv></span>人次</span></body></html>